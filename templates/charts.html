{% extends 'base.html' %}

{% block title %}Gráficos de Vuelos{% endblock %}

{% block content %}
<div class="header">
    <h1>Análisis de Vuelos</h1>
    <div class="user-info">
        <span class="user-avatar">{{ username[0]|upper }}</span>
        <span class="username">¡Hola, {{ username }}!</span>
    </div>
</div>

<div class="chart-controls">
    <div class="control-group">
        <label for="timeRange">Rango de tiempo:</label>
        <select id="timeRange" class="form-control">
            <option value="7">Últimos 7 días</option>
            <option value="30" selected>Últimos 30 días</option>
            <option value="90">Últimos 3 meses</option>
        </select>
    </div>
    <button id="refreshBtn" class="btn btn-primary">
        <i class="fas fa-sync-alt"></i> Actualizar
    </button>
</div>

<div class="chart-grid">
    <!-- Gráfico 1: Vuelos por Aerolínea -->
    <div class="chart-box">
        <h3><i class="fas fa-plane"></i> Vuelos por Aerolínea</h3>
        <div class="chart-container">
            <canvas id="flightsByAirlineChart"></canvas>
            <div class="loader-overlay" id="loaderFlightsByAirline">
                <div class="loader"></div>
            </div>
            <div class="chart-error" id="errorFlightsByAirline"></div>
        </div>
    </div>

    <!-- Gráfico 2: Estado de Vuelos -->
    <div class="chart-box">
        <h3><i class="fas fa-info-circle"></i> Estado de Vuelos</h3>
        <div class="chart-container">
            <canvas id="flightStatusChart"></canvas>
            <div class="loader-overlay" id="loaderFlightStatus">
                <div class="loader"></div>
            </div>
            <div class="chart-error" id="errorFlightStatus"></div>
        </div>
    </div>

    <!-- Gráfico 3: Vuelos Diarios -->
    <div class="chart-box full-width">
        <h3><i class="fas fa-calendar-alt"></i> Vuelos Diarios</h3>
        <div class="chart-container">
            <canvas id="dailyFlightsChart"></canvas>
            <div class="loader-overlay" id="loaderDailyFlights">
                <div class="loader"></div>
            </div>
            <div class="chart-error" id="errorDailyFlights"></div>
        </div>
    </div>
</div>

<script>
// Variables para almacenar las instancias de los gráficos
let flightsByAirlineChart, flightStatusChart, dailyFlightsChart;

// Colores para los gráficos según el tema
const themeColors = {
    light: {
        text: '#333',
        grid: 'rgba(0, 0, 0, 0.1)',
        background: '#fff'
    },
    dark: {
        text: '#fff',
        grid: 'rgba(255, 255, 255, 0.1)',
        background: '#2c3e50'
    }
};

// Función para obtener los colores actuales según el tema
function getCurrentThemeColors() {
    const currentTheme = document.body.getAttribute('data-theme') || 'light';
    return themeColors[currentTheme];
}

// Función para mostrar/ocultar el loader
function toggleLoader(chartId, show) {
    const loader = document.getElementById(`loader${chartId}`);
    const error = document.getElementById(`error${chartId}`);
    if (show) {
        loader.style.display = 'flex';
        error.textContent = '';
        error.style.display = 'none';
    } else {
        loader.style.display = 'none';
    }
}

// Función para mostrar errores
function showError(chartId, message) {
    const error = document.getElementById(`error${chartId}`);
    error.textContent = message;
    error.style.display = 'block';
    error.style.color = '#dc3545';
}

// Función para obtener datos de la API
async function fetchChartData(days = 30) {
    try {
        const response = await fetch(`/api/chart_data?days=${days}`);
        
        if (!response.ok) {
            throw new Error(`Error al obtener datos: ${response.statusText}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Error fetching chart data:', error);
        throw error;
    }
}

// Función para inicializar/actualizar los gráficos
async function updateCharts() {
    const days = document.getElementById('timeRange').value;
    const colors = getCurrentThemeColors();
    
    try {
        // Mostrar loaders
        toggleLoader('FlightsByAirline', true);
        toggleLoader('FlightStatus', true);
        toggleLoader('DailyFlights', true);
        
        const data = await fetchChartData(days);
        
        // 1. Gráfico de vuelos por aerolínea (Barras)
        const ctx1 = document.getElementById('flightsByAirlineChart').getContext('2d');
        const airlineColors = [
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(153, 102, 255, 0.7)'
        ];
        
        if (flightsByAirlineChart) {
            flightsByAirlineChart.destroy();
        }
        
        flightsByAirlineChart = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: data.vuelosPorAerolinea.labels,
                datasets: [{
                    label: 'Vuelos',
                    data: data.vuelosPorAerolinea.data,
                    backgroundColor: airlineColors,
                    borderColor: airlineColors.map(c => c.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.parsed.y} vuelos`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: colors.grid },
                        ticks: { color: colors.text }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: colors.text }
                    }
                }
            }
        });
        
        // 2. Gráfico de estado de vuelos (Dona)
        const ctx2 = document.getElementById('flightStatusChart').getContext('2d');
        const statusColors = [
            'rgba(75, 192, 192, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(255, 99, 132, 0.7)',
            'rgba(153, 102, 255, 0.7)'
        ];
        
        if (flightStatusChart) {
            flightStatusChart.destroy();
        }
        
        flightStatusChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: data.estadoVuelos.labels,
                datasets: [{
                    label: 'Estado',
                    data: data.estadoVuelos.data,
                    backgroundColor: statusColors,
                    borderColor: statusColors.map(c => c.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: colors.text }
                    },
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = Math.round((context.raw / total) * 100);
                                return `${context.label}: ${context.raw} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        // 3. Gráfico de vuelos diarios (Línea)
        const ctx3 = document.getElementById('dailyFlightsChart').getContext('2d');
        
        if (dailyFlightsChart) {
            dailyFlightsChart.destroy();
        }
        
        dailyFlightsChart = new Chart(ctx3, {
            type: 'line',
            data: {
                labels: data.vuelosDiarios.labels,
                datasets: [{
                    label: 'Vuelos',
                    data: data.vuelosDiarios.data,
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `${context.parsed.y} vuelos`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: colors.grid },
                        ticks: { color: colors.text }
                    },
                    x: {
                        grid: { color: colors.grid },
                        ticks: { color: colors.text }
                    }
                }
            }
        });
        
        // Ocultar loaders
        toggleLoader('FlightsByAirline', false);
        toggleLoader('FlightStatus', false);
        toggleLoader('DailyFlights', false);
        
    } catch (error) {
        console.error('Error al actualizar gráficos:', error);
        showError('FlightsByAirline', 'Error al cargar datos de aerolíneas');
        showError('FlightStatus', 'Error al cargar estados de vuelo');
        showError('DailyFlights', 'Error al cargar vuelos diarios');
        
        toggleLoader('FlightsByAirline', false);
        toggleLoader('FlightStatus', false);
        toggleLoader('DailyFlights', false);
    }
}

// Event Listeners
document.getElementById('refreshBtn').addEventListener('click', updateCharts);
document.getElementById('timeRange').addEventListener('change', updateCharts);

// Observar cambios de tema para actualizar gráficos
const themeObserver = new MutationObserver(updateCharts);
themeObserver.observe(document.body, { 
    attributes: true, 
    attributeFilter: ['data-theme'] 
});

// Inicializar gráficos al cargar la página
document.addEventListener('DOMContentLoaded', updateCharts);
</script>

<style>
.chart-controls {
    background-color: var(--bg-secondary);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-box {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.chart-box.full-width {
    grid-column: 1 / -1;
}

.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
    margin-top: 15px;
}

.loader-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    border-radius: 8px;
    z-index: 10;
}

.chart-error {
    color: #dc3545;
    margin-top: 10px;
    display: none;
    text-align: center;
}

@media (max-width: 768px) {
    .chart-grid {
        grid-template-columns: 1fr;
    }
    
    .chart-controls {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>
{% endblock %}